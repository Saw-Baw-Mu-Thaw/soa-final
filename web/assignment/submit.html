<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Submit Assignment | University LMS</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../css/materialCreate.css">
</head>

<body>

    <div class="dashboard-wrapper">
        <nav class="top-nav">
            <div class="nav-brand">University LMS</div>

            <div class="nav-controls">
                <div class="dashboard-nav">
                    <button id="dashboard-link">Dashboard</button>
                </div>

                <div class="profile-wrapper" onclick="window.location.href='../profile.html'" style="cursor: pointer;">
                    <span id="user-name">Student Name</span>
                    <i class="fas fa-user-circle fa-lg"></i>
                </div>

                <button class="btn-logout" onclick="logout()" style="margin-left: 15px;">Logout</button>
            </div>
        </nav>

        <div class="main-layout">
            <section id="content-area" class="content-area">
                <h2 id="assignment-title">Loading Assignment...</h2>
                
                <div id="assignment-info" style="display: none;">
                    <div class="form-group">
                        <h3>Description</h3>
                        <div id="description" style="padding: 15px; background: var(--bg-secondary); border-radius: 5px; min-height: 100px;">
                            <p id="description-text"></p>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div class="form-group">
                            <h3>Deadline</h3>
                            <p id="deadline" style="font-size: 1.1rem; font-weight: bold; color: var(--primary);"></p>
                        </div>

                        <div class="form-group">
                            <h3>Allowed File Type</h3>
                            <p id="filetype" style="font-size: 1.1rem; font-weight: bold;"></p>
                        </div>
                    </div>

                    <div class="form-group">
                        <h3>Upload Your Submission</h3>
                        <input type="file" id="file-input" accept="*/*" style="padding: 10px; border: 2px dashed var(--border-color); border-radius: 5px; width: 100%;">
                        <p id="file-info" style="margin-top: 10px; color: var(--text-secondary); font-size: 0.9rem;"></p>
                    </div>

                    <div id="error-message" style="display: none; color: red; padding: 15px; background: #ffe6e6; border-radius: 5px; margin: 20px 0;">
                        <p id="error-text"></p>
                    </div>

                    <div id="success-message" style="display: none; color: green; padding: 15px; background: #e6ffe6; border-radius: 5px; margin: 20px 0;">
                        <p id="success-text"></p>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button id="submit-btn" class="btn-primary">Submit Assignment</button>
                        <button id="cancel-btn" class="btn-secondary">Cancel</button>
                    </div>
                </div>

                <div id="loading-message" style="display: none; padding: 20px; text-align: center;">
                    <p>Loading assignment details...</p>
                </div>
            </section>
        </div>
    </div>

    <script src="../js/dashboard-common.js"></script>
    <script src="../js/assignments.js"></script>
    <script>
        // GATEWAY, currentUser, and token are already declared in dashboard-common.js
        let assignmentId = null
        let courseId = null
        let assignmentData = null
        let selectedFile = null

        async function ready() {
            // Get auth
            const storedRole = localStorage.getItem('lms_role');
            token = localStorage.getItem('token');

            if (!storedRole || !token || storedRole !== 'student') {
                alert("Unauthorized access. Redirecting to login.");
                window.location.href = '../index.html';
                return;
            }

            // Get user info
            await fetchUser();

            if (currentUser) {
                document.getElementById('user-name').innerText = currentUser['name'];
            }

            // Get URL parameters
            const url = new URL(window.location.href);
            const params = new URLSearchParams(url.search);
            assignmentId = parseInt(params.get('assignmentId'));
            courseId = params.get('courseId');

            if (!assignmentId) {
                showError('No assignment ID provided');
                return;
            }

            // Initialize dashboard button
            initializeDashboardBtn();

            // Load assignment details
            await loadAssignmentDetails();

            // Setup file input handler
            document.getElementById('file-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectedFile = file;
                    document.getElementById('file-info').textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                } else {
                    selectedFile = null;
                    document.getElementById('file-info').textContent = '';
                }
            });

            // Setup submit button
            document.getElementById('submit-btn').addEventListener('click', async () => {
                if (!selectedFile) {
                    showError('Please select a file to submit');
                    return;
                }
                await submitAssignment();
            });

            // Setup cancel button
            document.getElementById('cancel-btn').addEventListener('click', () => {
                // Use courseId from assignment data if available
                let finalCourseId = courseId;
                if (assignmentData && assignmentData.courseId) {
                    finalCourseId = assignmentData.courseId;
                }
                
                let url = './view.html?assignmentId=' + assignmentId;
                // Only add courseId if it's valid (not null, undefined, 0, or empty string)
                if (finalCourseId && finalCourseId !== '0' && finalCourseId !== 0) {
                    url += '&courseId=' + finalCourseId;
                }
                window.location.replace(url);
            });
        }

        async function fetchUser() {
            let url = GATEWAY + '/auth/me'
            await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            }).then(async (response) => {
                if (response.ok) {
                    let json = await response.json()
                    currentUser = json
                } else {
                    console.log('Could not fetch user info')
                }
            })
        }

        async function loadAssignmentDetails() {
            if (!currentUser || !currentUser['studentId']) {
                showError('Could not get student information');
                return;
            }

            const studentId = currentUser['studentId'];
            let url = GATEWAY + `/homework/${assignmentId}/${studentId}`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    assignmentData = await response.json();
                    // Use courseId from assignment data if available (more reliable)
                    if (assignmentData && assignmentData.courseId) {
                        courseId = assignmentData.courseId;
                    }
                    displayAssignment(assignmentData);
                } else {
                    const errorData = await response.json().catch(() => ({ detail: 'Failed to load assignment' }));
                    showError(errorData.detail || 'Failed to load assignment');
                }
            } catch (error) {
                console.error('Error loading assignment:', error);
                showError('Network error: Could not connect to server');
            }
        }

        function displayAssignment(data) {
            document.getElementById('assignment-title').textContent = data.title || 'Submit Assignment';
            document.getElementById('description-text').textContent = data.description || 'No description provided.';
            
            // Format deadline
            const deadline = new Date(data.deadline);
            const deadlineStr = deadline.toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('deadline').textContent = deadlineStr;

            // Check if deadline has passed
            const now = new Date();
            const isPastDeadline = deadline < now;
            if (isPastDeadline) {
                document.getElementById('deadline').style.color = 'red';
                document.getElementById('deadline').innerHTML += ' <span style="color: red;">(Past Deadline)</span>';
            }

            // File type
            const filetype = data.filetype || 'Any file type';
            document.getElementById('filetype').textContent = filetype.toUpperCase();
            
            // Set file input accept attribute based on filetype
            const fileInput = document.getElementById('file-input');
            if (filetype !== 'any') {
                const acceptMap = {
                    'pdf': '.pdf',
                    'doc': '.doc,.docx',
                    'txt': '.txt',
                    'zip': '.zip'
                };
                fileInput.accept = acceptMap[filetype.toLowerCase()] || '*/*';
            }

            // Show assignment info
            document.getElementById('assignment-info').style.display = 'block';
            document.getElementById('loading-message').style.display = 'none';
        }

        async function submitAssignment() {
            if (!selectedFile || !currentUser || !currentUser['studentId']) {
                showError('Missing required information');
                return;
            }

            // Disable submit button
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                // Convert file to base64
                const base64String = await fileToBase64(selectedFile);

                // Prepare submission data
                const submissionData = {
                    studentId: currentUser['studentId'],
                    homeworkId: assignmentId,
                    file: base64String,
                    filename: selectedFile.name
                };

                // Submit to API
                const url = GATEWAY + `/homework/${assignmentId}/submit`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(submissionData)
                });

                const result = await response.json();

                if (response.ok) {
                    // Success
                    const isLate = result.lateness && result.lateness.is_late;
                    const message = isLate 
                        ? `Submission successful! (Submitted ${result.lateness.time_difference} after deadline)`
                        : 'Submission successful!';
                    
                    showSuccess(message);
                    submitBtn.style.display = 'none';
                    
                    // Redirect to view page after 2 seconds
                    setTimeout(() => {
                        // Use courseId from assignment data if available
                        let finalCourseId = courseId;
                        if (assignmentData && assignmentData.courseId) {
                            finalCourseId = assignmentData.courseId;
                        }
                        
                        let redirectUrl = './view.html?assignmentId=' + assignmentId;
                        // Only add courseId if it's valid (not null, undefined, 0, or empty string)
                        if (finalCourseId && finalCourseId !== '0' && finalCourseId !== 0) {
                            redirectUrl += '&courseId=' + finalCourseId;
                        }
                        window.location.replace(redirectUrl);
                    }, 2000);
                } else {
                    // Error
                    showError(result.detail || 'Failed to submit assignment');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Assignment';
                }
            } catch (error) {
                console.error('Error submitting assignment:', error);
                showError('Network error: Could not submit assignment');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Assignment';
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Remove data URL prefix (e.g., "data:application/pdf;base64,")
                    const base64 = reader.result.split(',')[1] || reader.result;
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function showError(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('success-message').style.display = 'none';
        }

        function showSuccess(message) {
            document.getElementById('success-text').textContent = message;
            document.getElementById('success-message').style.display = 'block';
            document.getElementById('error-message').style.display = 'none';
        }

        function initializeDashboardBtn() {
            let dashboardBtn = document.getElementById('dashboard-link');
            dashboardBtn.addEventListener('click', () => {
                // Use courseId from assignment data if available, otherwise from URL
                let finalCourseId = courseId;
                if (assignmentData && assignmentData.courseId) {
                    finalCourseId = assignmentData.courseId;
                }
                
                let url = '../student.html';
                // Only add courseId if it's valid (not null, undefined, 0, or empty string)
                if (finalCourseId && finalCourseId !== '0' && finalCourseId !== 0) {
                    url += '?courseId=' + finalCourseId;
                }
                window.location.replace(url);
            });
        }

        function logout() {
            localStorage.clear();
            window.location.href = '../index.html';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            ready();
        });
    </script>
</body>

</html>

