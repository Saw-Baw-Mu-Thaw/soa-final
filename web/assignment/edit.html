<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Edit Assignment | University LMS</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../css/materialCreate.css">
</head>

<body>

    <div class="dashboard-wrapper">
        <nav class="top-nav">
            <div class="nav-brand">University LMS</div>

            <div class="nav-controls">
                <div class="dashboard-nav">
                    <button id="dashboard-link">Dashboard</button>
                </div>

                <div class="profile-wrapper" onclick="window.location.href='../profile.html'" style="cursor: pointer;">
                    <span id="user-name">Teacher Name</span>
                    <i class="fas fa-user-tie fa-lg"></i>
                </div>

                <button class="btn-logout" onclick="logout()" style="margin-left: 15px;">Logout</button>
            </div>
        </nav>

        <div class="main-layout">
            <section id="content-area" class="content-area">
                <h2 id="assignment-action">Edit Assignment</h2>

                <div id="loading-message" style="display: none; padding: 20px; text-align: center;">
                    <p>Loading assignment details...</p>
                </div>

                <div id="assignment-form" style="display: none;">
                    <div class="form-group">
                        <h3>Title</h3>
                        <input type="text" id="title" placeholder="Assignment title">
                    </div>

                    <div class="form-group">
                        <h3>Description</h3>
                        <textarea id="description" rows="4" placeholder="Assignment description"></textarea>
                    </div>

                    <div class="form-group">
                        <h3>Deadline</h3>
                        <input type="datetime-local" id="deadline">
                    </div>

                    <div class="form-group">
                        <h3>File Type</h3>
                        <select id="filetype">
                            <option value="pdf">PDF</option>
                            <option value="doc">Word Document</option>
                            <option value="txt">Text File</option>
                            <option value="zip">ZIP Archive</option>
                            <option value="any">Any File Type</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="send-notification">
                            <span>Send notification to students about this update</span>
                        </label>
                    </div>

                    <div id="error-message" style="display: none; color: red; padding: 15px; background: #ffe6e6; border-radius: 5px; margin: 20px 0;">
                        <p id="error-text"></p>
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button id="saveBtn" class="btn-primary">Save Changes</button>
                        <button id="cancelBtn" class="btn-secondary">Cancel</button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script src="../js/dashboard-common.js"></script>
    <script src="../js/assignments.js"></script>
    <script>
        // GATEWAY, currentUser, and token are already declared in dashboard-common.js
        let assignmentId = null
        let courseId = null
        let assignmentData = null

        async function ready() {
            const storedRole = localStorage.getItem('lms_role');
            token = localStorage.getItem('token');

            if (!storedRole || !token || storedRole !== 'teacher') {
                alert("Unauthorized access. Redirecting to login.");
                window.location.href = '../index.html';
                return;
            }

            await fetchUser();

            if (currentUser) {
                document.getElementById('user-name').innerText = currentUser['name'];
            }

            // Get URL parameters
            const url = new URL(window.location.href);
            const params = new URLSearchParams(url.search);
            assignmentId = parseInt(params.get('assignmentId'));
            courseId = params.get('courseId');

            if (!assignmentId) {
                showError('No assignment ID provided');
                return;
            }

            // Initialize dashboard button
            initializeDashboardBtn();

            // Setup cancel button
            document.getElementById('cancelBtn').addEventListener('click', () => {
                let redirectUrl = '../course.html';
                if (courseId) {
                    redirectUrl += '?courseId=' + courseId;
                }
                window.location.replace(redirectUrl);
            });

            // Setup save button
            document.getElementById('saveBtn').addEventListener('click', async () => {
                await saveAssignment();
            });

            // Load assignment details
            await loadAssignmentDetails();
        }

        async function fetchUser() {
            let url = GATEWAY + '/auth/me'
            await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            }).then(async (response) => {
                if (response.ok) {
                    let json = await response.json()
                    currentUser = json
                } else {
                    console.log('Could not fetch user info')
                }
            })
        }

        async function loadAssignmentDetails() {
            // Use student_id=0 as placeholder to get homework details
            // The endpoint requires a student_id but we just need the homework info
            const studentId = 0;
            const url = GATEWAY + `/homework/${assignmentId}/${studentId}`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    assignmentData = await response.json();
                    populateForm(assignmentData);
                    document.getElementById('loading-message').style.display = 'none';
                    document.getElementById('assignment-form').style.display = 'block';
                } else {
                    const errorData = await response.json().catch(() => ({ detail: 'Failed to load assignment' }));
                    showError(errorData.detail || 'Failed to load assignment');
                }
            } catch (error) {
                console.error('Error loading assignment:', error);
                showError('Network error: Could not connect to server');
            }
        }

        function populateForm(data) {
            document.getElementById('title').value = data.title || '';
            document.getElementById('description').value = data.description || '';
            
            // Format deadline for datetime-local input
            if (data.deadline) {
                const deadline = new Date(data.deadline);
                // Convert to local datetime string format (YYYY-MM-DDTHH:mm)
                const year = deadline.getFullYear();
                const month = String(deadline.getMonth() + 1).padStart(2, '0');
                const day = String(deadline.getDate()).padStart(2, '0');
                const hours = String(deadline.getHours()).padStart(2, '0');
                const minutes = String(deadline.getMinutes()).padStart(2, '0');
                document.getElementById('deadline').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            }
            
            // Set filetype
            if (data.filetype) {
                document.getElementById('filetype').value = data.filetype.toLowerCase();
            }
        }

        async function saveAssignment() {
            if (!await inputValid()) {
                return;
            }

            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const deadline = document.getElementById('deadline').value;
            const filetype = document.getElementById('filetype').value;
            const sendNotification = document.getElementById('send-notification').checked;

            const body = {
                'title': title,
                'description': description,
                'deadline': deadline,
                'filetype': filetype
            };

            // Add courseId if we have it (optional for update)
            if (courseId) {
                body['courseId'] = parseInt(courseId);
            }

            const url = GATEWAY + `/homework/${assignmentId}?send_notification=${sendNotification}`;

            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    body: JSON.stringify(body),
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    // Success - redirect back to course page
                    let redirectUrl = '../course.html';
                    if (courseId) {
                        redirectUrl += '?courseId=' + courseId;
                    }
                    window.location.replace(redirectUrl);
                } else {
                    const errorData = await response.json().catch(() => ({ detail: 'Failed to update assignment' }));
                    showError(errorData.detail || 'Failed to update assignment');
                }
            } catch (error) {
                console.error('Error updating assignment:', error);
                showError('Network error: Could not update assignment');
            }
        }

        async function inputValid() {
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const deadline = document.getElementById('deadline').value;

            if (title.length === 0) {
                alert('Title cannot be empty');
                return false;
            }
            if (description.length === 0) {
                alert('Description cannot be empty');
                return false;
            }
            if (!deadline) {
                alert('Deadline must be set');
                return false;
            }

            return true;
        }

        function showError(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('loading-message').style.display = 'none';
        }

        function initializeDashboardBtn() {
            let dashboardBtn = document.getElementById('dashboard-link');
            dashboardBtn.addEventListener('click', () => {
                let url = '../course.html';
                if (courseId) {
                    url += '?courseId=' + courseId;
                }
                window.location.replace(url);
            });
        }

        function logout() {
            localStorage.clear();
            window.location.href = '../index.html';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            ready();
        });
    </script>
</body>

</html>

