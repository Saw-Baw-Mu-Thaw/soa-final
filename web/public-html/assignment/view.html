<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Assignment Details | University LMS</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <div class="dashboard-wrapper">
        <nav class="top-nav">
            <div class="nav-brand">University LMS</div>

            <div class="nav-controls">
                <div class="dashboard-nav">
                    <button id="dashboard-link">Dashboard</button>
                </div>

                <div class="profile-wrapper" onclick="window.location.href='../profile.html'" style="cursor: pointer;">
                    <span id="user-name">Student Name</span>
                    <i class="fas fa-user-circle fa-lg"></i>
                </div>

                <button class="btn-logout" onclick="logout()" style="margin-left: 15px;">Logout</button>
            </div>
        </nav>

        <div class="main-layout">
            <section id="content-area" class="content-area">
                <h2 id="assignment-title">Loading Assignment...</h2>
                <div id="assignment-details" style="display: none;">
                    <div class="form-group">
                        <h3>Description</h3>
                        <div id="description" style="padding: 15px; background: var(--bg-secondary); border-radius: 5px; min-height: 100px;">
                            <p id="description-text"></p>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div class="form-group">
                            <h3>Deadline</h3>
                            <p id="deadline" style="font-size: 1.1rem; font-weight: bold; color: var(--primary);"></p>
                        </div>

                        <div class="form-group">
                            <h3>Allowed File Type</h3>
                            <p id="filetype" style="font-size: 1.1rem; font-weight: bold;"></p>
                        </div>
                    </div>

                    <div class="form-group" id="attempts-info" style="margin: 20px 0; padding: 15px; background: var(--bg-secondary); border-radius: 5px;">
                        <h3>Submission Attempts</h3>
                        <p id="attempts-text" style="font-size: 1.1rem; font-weight: bold;"></p>
                    </div>

                    <div id="submission-status" style="margin: 20px 0; padding: 15px; background: var(--bg-secondary); border-radius: 5px;">
                        <h3>Submission Status</h3>
                        <div id="submission-info"></div>
                    </div>

                    <div id="grades-section" style="margin: 20px 0; padding: 15px; background: var(--bg-secondary); border-radius: 5px; display: none;">
                        <h3>Grades & Scores</h3>
                        <div id="grades-info"></div>
                    </div>

                    <div id="action-buttons" style="margin-top: 30px;">
                        <button id="submit-btn" class="btn-primary" style="display: none;">Submit Assignment</button>
                        <button id="resubmit-btn" class="btn-primary" style="display: none;">Resubmit Assignment</button>
                    </div>
                </div>

                <div id="error-message" style="display: none; color: red; padding: 20px;">
                    <h3>Error Loading Assignment</h3>
                    <p id="error-text"></p>
                </div>
            </section>
        </div>
    </div>

    <script src="../js/dashboard-common.js"></script>
    <script src="../js/assignments.js"></script>
    <script>
        // GATEWAY, currentUser, and token are already declared in dashboard-common.js
        let assignmentId = null
        let courseId = null
        let assignmentData = null

        async function ready() {
            // Get auth
            const storedRole = localStorage.getItem('lms_role');
            token = localStorage.getItem('token');

            if (!storedRole || !token || storedRole !== 'student') {
                alert("Unauthorized access. Redirecting to login.");
                window.location.href = '../index.html';
                return;
            }

            // Get user info
            await fetchUser();

            if (currentUser) {
                document.getElementById('user-name').innerText = currentUser['name'];
            }

            // Get URL parameters
            const url = new URL(window.location.href);
            const params = new URLSearchParams(url.search);
            assignmentId = parseInt(params.get('assignmentId'));
            courseId = params.get('courseId');

            if (!assignmentId) {
                showError('No assignment ID provided');
                return;
            }

            // Initialize dashboard button
            initializeDashboardBtn();

            // Load assignment details
            await loadAssignmentDetails();
        }

        async function fetchUser() {
            let url = GATEWAY + '/auth/me'
            await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            }).then(async (response) => {
                if (response.ok) {
                    let json = await response.json()
                    currentUser = json
                } else {
                    console.log('Could not fetch user info')
                }
            })
        }

        async function loadAssignmentDetails() {
            if (!currentUser || !currentUser['studentId']) {
                showError('Could not get student information');
                return;
            }

            const studentId = currentUser['studentId'];
            let url = GATEWAY + `/homework/${assignmentId}/${studentId}`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    assignmentData = await response.json();
                    displayAssignment(assignmentData);
                } else {
                    const errorData = await response.json().catch(() => ({ detail: 'Failed to load assignment' }));
                    showError(errorData.detail || 'Failed to load assignment');
                }
            } catch (error) {
                console.error('Error loading assignment:', error);
                showError('Network error: Could not connect to server');
            }
        }

        function displayAssignment(data) {
            document.getElementById('assignment-title').textContent = data.title || 'Assignment';
            document.getElementById('description-text').textContent = data.description || 'No description provided.';
            
            // Format deadline
            const deadline = new Date(data.deadline);
            const deadlineStr = deadline.toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('deadline').textContent = deadlineStr;

            // Check if deadline has passed
            const now = new Date();
            const isPastDeadline = deadline < now;
            if (isPastDeadline) {
                document.getElementById('deadline').style.color = 'red';
                document.getElementById('deadline').innerHTML += ' <span style="color: red;">(Past Deadline)</span>';
            }

            // File type
            const filetype = data.filetype || 'Any file type';
            document.getElementById('filetype').textContent = filetype.toUpperCase();

            // Attempts information
            const attemptsInfo = document.getElementById('attempts-info');
            const attemptsText = document.getElementById('attempts-text');
            if (data.maxAttempts !== null && data.maxAttempts !== undefined) {
                if (data.remainingAttempt !== null && data.remainingAttempt !== undefined) {
                    if (data.remainingAttempt > 0) {
                        attemptsText.innerHTML = `
                            <span style="color: var(--primary);">
                                <i class="fas fa-check-circle"></i> ${data.remainingAttempt} attempt${data.remainingAttempt !== 1 ? 's' : ''} remaining out of ${data.maxAttempts}
                            </span>
                        `;
                    } else {
                        attemptsText.innerHTML = `
                            <span style="color: red;">
                                <i class="fas fa-times-circle"></i> No attempts remaining (${data.maxAttempts} attempts used)
                            </span>
                        `;
                    }
                } else {
                    attemptsText.innerHTML = `
                        <span style="color: var(--primary);">
                            <i class="fas fa-info-circle"></i> Maximum ${data.maxAttempts} attempt${data.maxAttempts !== 1 ? 's' : ''} allowed
                        </span>
                    `;
                }
            } else {
                attemptsText.innerHTML = `
                    <span style="color: var(--primary);">
                        <i class="fas fa-infinity"></i> Unlimited attempts allowed
                    </span>
                `;
            }

            // Load submission history to show grades (non-blocking)
            loadSubmissionHistory(assignmentId, currentUser['studentId']).catch(err => {
                console.log('[DEBUG] Submission history load failed (non-critical):', err);
            });

            // Submission status
            const submissionInfo = document.getElementById('submission-info');
            if (data.submission) {
                let scoreDisplay = '';
                if (data.submission.isReleased === true && data.submission.score !== null && data.submission.score !== undefined) {
                    scoreDisplay = `
                        <p style="margin-top: 10px; padding: 10px; background: var(--bg-primary); border-radius: 5px; border-left: 4px solid var(--primary);">
                            <strong>Score:</strong> 
                            <span style="color: var(--primary); font-weight: bold; font-size: 1.2rem;">${data.submission.score} points</span>
                        </p>
                    `;
                }
                submissionInfo.innerHTML = `
                    <p style="color: green; font-weight: bold;">
                        <i class="fas fa-check-circle"></i> Submitted
                    </p>
                    <p style="margin-top: 10px;">Submission ID: ${data.submission.submissionId}</p>
                    <p>File: ${data.submission.path.split('/').pop()}</p>
                    ${scoreDisplay}
                `;
                // Show resubmit button only if attempts remaining
                if (data.remainingAttempt === null || data.remainingAttempt > 0) {
                    document.getElementById('resubmit-btn').style.display = 'inline-block';
                } else {
                    document.getElementById('resubmit-btn').style.display = 'none';
                }
            } else {
                submissionInfo.innerHTML = `
                    <p style="color: orange; font-weight: bold;">
                        <i class="fas fa-exclamation-circle"></i> Not Submitted
                    </p>
                `;
                // Show submit button only if attempts remaining
                if (data.remainingAttempt === null || data.remainingAttempt > 0) {
                    document.getElementById('submit-btn').style.display = 'inline-block';
                } else {
                    document.getElementById('submit-btn').style.display = 'none';
                }
            }

            // Show assignment details
            document.getElementById('assignment-details').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').style.display = 'block';
        }

        function initializeDashboardBtn() {
            let dashboardBtn = document.getElementById('dashboard-link');
            dashboardBtn.addEventListener('click', () => {
                let url = '../student.html';
                if (courseId) {
                    url += '?courseId=' + courseId;
                }
                window.location.replace(url);
            });
        }

        // Submit button handlers
        document.getElementById('submit-btn')?.addEventListener('click', () => {
            submitAssignment(assignmentId);
        });

        document.getElementById('resubmit-btn')?.addEventListener('click', () => {
            if (confirm('Are you sure you want to resubmit? This will create a new submission.')) {
                submitAssignment(assignmentId);
            }
        });

        async function loadSubmissionHistory(homeworkId, studentId) {
            const url = GATEWAY + `/homework/submission/${homeworkId}/${studentId}`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const submissions = await response.json();
                    displayGrades(submissions);
                }
            } catch (error) {
                console.error('Error loading submission history:', error);
            }
        }

        function displayGrades(submissions) {
            const gradesSection = document.getElementById('grades-section');
            const gradesInfo = document.getElementById('grades-info');

            if (!submissions || submissions.length === 0) {
                gradesSection.style.display = 'none';
                return;
            }

            // Filter to only show released grades
            const releasedSubmissions = submissions.filter(sub => sub.isReleased === true && sub.score !== null);

            if (releasedSubmissions.length === 0) {
                gradesSection.style.display = 'none';
                return;
            }

            let gradesHTML = '';
            releasedSubmissions.forEach(sub => {
                gradesHTML += `
                    <div style="padding: 10px; margin: 10px 0; background: var(--bg-primary); border-radius: 5px; border-left: 4px solid var(--primary);">
                        <p style="margin: 5px 0;">
                            <strong>Attempt ${sub.attemptNumber}:</strong> 
                            <span style="color: var(--primary); font-weight: bold; font-size: 1.1rem;">${sub.score} points</span>
                        </p>
                    </div>
                `;
            });

            gradesInfo.innerHTML = gradesHTML;
            gradesSection.style.display = 'block';
        }

        function submitAssignment(assignmentId) {
            let url = './submit.html?assignmentId=' + assignmentId;
            if (courseId) {
                url += '&courseId=' + courseId;
            }
            window.location.replace(url);
        }

        function logout() {
            localStorage.clear();
            window.location.href = '../index.html';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            ready();
        });
    </script>
</body>

</html>

